name: Production Deployment

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-20.04

    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v3

    - name: 🛠️ Setup .NET SDK
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '9.0.x'

    - name: 📦 Restore dependencies
      run: dotnet restore ReportHub/ReportHub.sln

    - name: 🔨 Build solution
      run: dotnet build ReportHub/ReportHub.sln --configuration Release --no-restore

    - name: 🔧 Set Heroku Stack to Container
      run: heroku stack:set container -a ${{ secrets.HEROKU_APP_NAME }}

    - name: 🚀 Deploy to Heroku
      env:
        HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
        HEROKU_APP_NAME: ${{ secrets.HEROKU_APP_NAME }}
      run: |
        curl https://cli-assets.heroku.com/install.sh | sh
        heroku container:login
        heroku container:push web --app $HEROKU_APP_NAME
        heroku container:release web --app $HEROKU_APP_NAME