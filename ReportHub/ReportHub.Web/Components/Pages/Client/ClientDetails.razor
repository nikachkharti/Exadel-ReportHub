@page "/client-details"
@inject SelectedClientState SelectedClientState
@inject IClientService ClientService
@rendermode InteractiveServer

<h3>Client Details</h3>

@if (SelectedClientState.SelectedClient == null)
{
    <p>No client selected.</p>
}
else
{
    var client = SelectedClientState.SelectedClient;

    <div class="card">
        @* CARD INFO *@
        <div class="card-header d-flex justify-content-between align-content-center">
            @client.Id
            <a href="/clients" class="btn btn-primary">Back</a>
        </div>
        <div class="card-body">
            <h5 class="card-title">@client.Name</h5>
            <p class="card-text">@client.Specialization</p>
        </div>

        <div class="accordion">

            @* ITEMS *@
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button @(!isItemsOpen ? "collapsed" : "")"
                            @onclick="ToggleItemsAccordion"
                            type="button"
                            aria-expanded="@isItemsOpen">
                        Items
                    </button>
                </h2>
                <div class="accordion-collapse collapse @(isItemsOpen ? "show" : "")">
                    <div class="accordion-body">
                        @if (isItemsLoading)
                        {
                            <p>Loading items...</p>
                        }
                        else if (items != null && items.Any())
                        {
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th @onclick="() => ChangeSorting(nameof(ItemForGettingDto.Name))">
                                            Name @SortIcon(nameof(ItemForGettingDto.Name))
                                        </th>
                                        <th @onclick="() => ChangeSorting(nameof(ItemForGettingDto.Id))">
                                            ID @SortIcon(nameof(ItemForGettingDto.Id))
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in items)
                                    {
                                        <tr>
                                            <td>@item.Name</td>
                                            <td>@item.Id</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }
                        else
                        {
                            <p>No items found.</p>
                        }
                        <nav>
                            <ul class="pagination">
                                <li class="page-item @( _itemPage == 1 ? "disabled" : "")">
                                    <button class="page-link" @onclick="PreviousPage">Previous</button>
                                </li>
                                <li class="page-item">
                                    <span class="page-link">@_itemPage</span>
                                </li>
                                <li class="page-item">
                                    <button class="page-link" @onclick="NextPage">Next</button>
                                </li>
                            </ul>
                        </nav>

                    </div>
                </div>
            </div>

            <!-- PLANS -->
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button @(!isPlansOpen ? "collapsed" : "")"
                            @onclick="TogglePlansAccordion"
                            type="button"
                            aria-expanded="@isPlansOpen">
                        Plans
                    </button>
                </h2>
                <div class="accordion-collapse collapse @(isPlansOpen ? "show" : "")">
                    <div class="accordion-body">
                        @if (isPlansLoading)
                        {
                            <p>Loading plans...</p>
                        }
                        else if (plans != null && plans.Any())
                        {
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th @onclick="() => ChangePlanSorting(nameof(PlanForGettingDto.Id))">
                                            ID @SortPlanIcon(nameof(PlanForGettingDto.Id))
                                        </th>
                                        <th @onclick="() => ChangePlanSorting(nameof(PlanForGettingDto.Status))">
                                            Status @SortPlanIcon(nameof(PlanForGettingDto.Status))
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var plan in plans)
                                    {
                                        <tr>
                                            <td>@plan.Id</td>
                                            <td>@plan.Status</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }
                        else
                        {
                            <p>No plans found.</p>
                        }

                        <nav>
                            <ul class="pagination">
                                <li class="page-item @( _planPage == 1 ? "disabled" : "")">
                                    <button class="page-link" @onclick="PreviousPlanPage">Previous</button>
                                </li>
                                <li class="page-item">
                                    <span class="page-link">@_planPage</span>
                                </li>
                                <li class="page-item">
                                    <button class="page-link" @onclick="NextPlanPage">Next</button>
                                </li>
                            </ul>
                        </nav>

                    </div>
                </div>
            </div>

            <!-- SALES -->
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button @(!isSalesOpen ? "collapsed" : "")"
                            @onclick="ToggleSalesAccordion"
                            type="button"
                            aria-expanded="@isSalesOpen">
                        Sales
                    </button>
                </h2>
                <div class="accordion-collapse collapse @(isSalesOpen ? "show" : "")">
                    <div class="accordion-body">
                        @if (isSalesLoading)
                        {
                            <p>Loading sales...</p>
                        }
                        else if (sales != null && sales.Any())
                        {
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th @onclick="() => ChangeSaleSorting(nameof(SaleForGettingDto.SaleDate))">
                                            Sale Date @SortSaleIcon(nameof(SaleForGettingDto.SaleDate))
                                        </th>
                                        <th @onclick="() => ChangeSaleSorting(nameof(SaleForGettingDto.Amount))">
                                            Amount @SortSaleIcon(nameof(SaleForGettingDto.Amount))
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var sale in sales)
                                    {
                                        <tr>
                                            <td>@sale.SaleDate.ToString("yyyy-MM-dd")</td>
                                            <td>@sale.Amount</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }
                        else
                        {
                            <p>No sales found.</p>
                        }

                        <nav>
                            <ul class="pagination">
                                <li class="page-item @( _salePage == 1 ? "disabled" : "")">
                                    <button class="page-link" @onclick="PreviousSalePage">Previous</button>
                                </li>
                                <li class="page-item">
                                    <span class="page-link">@_salePage</span>
                                </li>
                                <li class="page-item">
                                    <button class="page-link" @onclick="NextSalePage">Next</button>
                                </li>
                            </ul>
                        </nav>

                    </div>
                </div>
            </div>


        </div>
    </div>
}

@code {

    // SALES section
    private bool isSalesOpen = false;
    private bool isSalesLoading = false;
    private List<SaleForGettingDto> sales;

    private int _salePage = 1;
    private int _salePageSize = 10;
    private string _saleSortBy = nameof(SaleForGettingDto.SaleDate);
    private bool _saleSortByAscending = false;

    private async Task ToggleSalesAccordion()
    {
        isSalesOpen = !isSalesOpen;

        if (isSalesOpen && sales == null)
        {
            await LoadSalesAsync();
        }
    }

    private async Task LoadSalesAsync()
    {
        if (SelectedClientState.SelectedClient is null) return;

        isSalesLoading = true;

        try
        {
            var clientId = SelectedClientState.SelectedClient.Id;
            var response = await ClientService.GetSalesOfClientAsync(clientId, _salePage, _salePageSize, _saleSortBy, _saleSortByAscending);
            sales = new();
            sales.AddRange(response);
        }
        catch (Exception)
        {
            // Optionally log error
        }
        finally
        {
            isSalesLoading = false;
        }
    }

    private async Task ChangeSaleSorting(string sortBy)
    {
        if (_saleSortBy == sortBy)
        {
            _saleSortByAscending = !_saleSortByAscending;
        }
        else
        {
            _saleSortBy = sortBy;
            _saleSortByAscending = true;
        }

        await LoadSalesAsync();
    }

    private async Task NextSalePage()
    {
        _salePage++;
        await LoadSalesAsync();
    }

    private async Task PreviousSalePage()
    {
        if (_salePage > 1)
        {
            _salePage--;
            await LoadSalesAsync();
        }
    }

    private MarkupString SortSaleIcon(string column)
    {
        if (_saleSortBy != column) return new MarkupString("");
        return _saleSortByAscending
            ? new MarkupString("&#9650;")
            : new MarkupString("&#9660;");
    }



    // Plans Section
    private bool isPlansOpen = false;
    private bool isPlansLoading = false;
    private List<PlanForGettingDto> plans;

    private int _planPage = 1;
    private int _planPageSize = 10;
    private string _planSortBy = nameof(PlanForGettingDto.Id);
    private bool _planSortByAscending = true;

    private async Task TogglePlansAccordion()
    {
        isPlansOpen = !isPlansOpen;

        if (isPlansOpen && plans == null)
        {
            await LoadPlansAsync();
        }
    }

    private async Task LoadPlansAsync()
    {
        if (SelectedClientState.SelectedClient is null) return;

        isPlansLoading = true;

        try
        {
            var clientId = SelectedClientState.SelectedClient.Id;
            var response = await ClientService.GetPlansOfClientAsync(clientId, _planPage, _planPageSize, _planSortBy, _planSortByAscending);
            plans = new();
            plans.AddRange(response);
        }
        catch (Exception)
        {
            // Handle or log exception
        }
        finally
        {
            isPlansLoading = false;
        }
    }

    private async Task ChangePlanSorting(string sortBy)
    {
        if (_planSortBy == sortBy)
        {
            _planSortByAscending = !_planSortByAscending;
        }
        else
        {
            _planSortBy = sortBy;
            _planSortByAscending = true;
        }

        await LoadPlansAsync();
    }

    private async Task NextPlanPage()
    {
        _planPage++;
        await LoadPlansAsync();
    }

    private async Task PreviousPlanPage()
    {
        if (_planPage > 1)
        {
            _planPage--;
            await LoadPlansAsync();
        }
    }

    private MarkupString SortPlanIcon(string column)
    {
        if (_planSortBy != column) return new MarkupString("");
        return _planSortByAscending
            ? new MarkupString("&#9650;")
            : new MarkupString("&#9660;");
    }



    //Item section
    private bool isItemsOpen = false;
    private bool isItemsLoading = false;
    private List<ItemForGettingDto> items;

    private int _itemPage = 1;
    private int _itemPageSize = 10;
    private string _itemSortBy = nameof(ItemForGettingDto.Id);
    private bool _itemSortByAscending = true;

    private async Task ToggleItemsAccordion()
    {
        isItemsOpen = !isItemsOpen;

        if (isItemsOpen && items == null)
        {
            await LoadItemsAsync();
        }
    }

    private async Task LoadItemsAsync()
    {
        if (SelectedClientState.SelectedClient is null) return;

        isItemsLoading = true;

        try
        {
            var clientId = SelectedClientState.SelectedClient.Id;
            var response = await ClientService.GetItemsOfClientAsync(clientId, _itemPage, _itemPageSize, _itemSortBy, _itemSortByAscending);
            items = new();
            items.AddRange(response);
        }
        catch (Exception)
        {
            // Optionally handle/log the error
        }
        finally
        {
            isItemsLoading = false;
        }
    }

    private async Task ChangeSorting(string sortBy)
    {
        if (_itemSortBy == sortBy)
        {
            _itemSortByAscending = !_itemSortByAscending;
        }
        else
        {
            _itemSortBy = sortBy;
            _itemSortByAscending = true;
        }

        await LoadItemsAsync();
    }

    private async Task NextPage()
    {
        _itemPage++;
        await LoadItemsAsync();
    }

    private async Task PreviousPage()
    {
        if (_itemPage > 1)
        {
            _itemPage--;
            await LoadItemsAsync();
        }
    }

    private MarkupString SortIcon(string column)
    {
        if (_itemSortBy != column) return new MarkupString("");
        return _itemSortByAscending
            ? new MarkupString("&#9650;") // ▲
            : new MarkupString("&#9660;"); // ▼
    }
}
